--- In class one we have seen the intro of IAC and terraform.
--- Today we will write codes and see how to write a code in terraform.

--- We will creat a file in the 'terraform-ws' folder only, called 'main.tf' and write some content in the file.
--- Now I want to create a S3 bucket using terraform. So we need to write it in HCL.
--- In terraform we have different yoes of blocks, first block we are going to see is 'resource block'. So you will write resource in thsi block.
--- Now lets go to terraform documentation --- browse terraform aws provider --- then search for S3, find what you want to create. As we want to create  aws S3 bucket select it and you can see the example code.
--- You can use the example and edit it as per your requirements.
--- Now, every aws resource has a lot of configurations when you create it from console and you can select options.However some option are compulsary, but some are optional and if you do not provide any value/select the option it will take as default options.
--- So, here in code as well we will provide the mandatory options and for optional we can add them in code if we require them.

--- Now in resourse block you have 

resource "aws_s3_bucket" "mys3" {
    bucket = "myfirstbucket"
    tags = {
        Name = "demoec2instance"
        Environment = "Dev"
        Owner = "devopsuser"
    }
}

--- So you want to create a resource with a type here "aws_s3 bucket" with name of resource as "mys3".
--- "mys3" is not the name of the bucket, it is logical name of the resource.
--- Then we have have provided required configurations.
--- bucket = "Myfirstbucket" ---> this is the name we would like to give to the bucket.
--- Then we have tags.So we have given tags.

--- Now after you have written the code you have come to the terminal option of VA code and run the command 

--- terrafrom plan --- first we have to do 'terrafrom init', we have already done it so we can directly do terform plan.

--- terrafrom plan is going to plan it, it is going to prepare a blueprint. So, it will not create the resources but will tell what resource are going to be created and etc.
--- So you can look at it and see what it is created and if you are ok with it you can proceed.
--- Once you are ok with the plan, then you can run the command 'terraform apply' and this will create the resources.

--- terraform apply

--- Now you can go and check in your aws console and see that the s3 bucket with name you have given is created.

--- Now lets create a ec2 instance using terraform.
--- Go to the terraform documentation and search for ec2 . Select the aws_instance from the options.
--- Just add this to the existing code in main.tf which we have written for creating s3 bucket.

resource "aws_s3_bucket" "mys3" {
    bucket = "myfirstbucket26856"
    tags = {
        Name = "demoec2instance"
        Environment = "Dev"
        Owner = "devopsuser"
    }
}


resource "aws_instance" "myec2" {
    ami = "ami-0861f4e788f5069dd"
    instance_type = "t2.mirco"
    tags = {
        Name = "demoec2instance"
        Environment = "Dev"
        Owner = "devopsuser"
    }
}

--- we are creating resource type "aws_instance" with the name "myec2".
--- We have given the ami id which we can get from the aws console when crating the ec2 instance.
--- also we have given the instance_type as t2.mirco.

--- Now when you do terraform apply, since we already the s3 bucket resource this will not effect it. Now first lest do terraform plan.

--- terraform plan

--- You can see it says that it is going to create a aws-instance.myec2. You can see configurations. Now do terraform apply.

--- terraform apply

--- You can go and check in aws console you can see the new instance got created.
--- Now the thing is that you have just added a new resource and terraform is updating your environment. It is not doing anything with the s3 bucket, since it knows that it is already exists.
--- You can also modify the code, the resources maybe you can chance the instance type from t2.micro to t2.nano and do terraform plan. But remember if you do that you will be charged by aws since t2.nano is not under free tier.
--- Also, it is not a good practice to modify any resource from aws console if is created using terraform.
--- Also, if you do instance tpe change the instance has to be stopped first, then change the instance type and then restart the instance the same happens with terraform as well. It will stop the instance first and then it will change the instance type.
--- Also you can see the public IP of the instance is changed. Since the instance is stopped and restarted.


--- Now how does terraform knows that wether it has to create something or whether modify something?
--- Here we have first created only 1 resource S3, then we created a resource aws_instance and then we modified the resource.
--- How does the terraform knwo that what are already present and only whats needs to be added or modified?
--- The answer is state file. 
--- You can see a new file got created, which is 'terraform.tfstate'. Which got created as soon as we did terraform apply.
--- So it got created when we did our first terraform apply to create s3 bucket.
--- This 'terraform.tfstate' is managing the state of your resource.
--- If you open 'terraform.tfstate' file. You can see the details of all the resources which your terraform is managing.
--- currently we have 2resources, one is s3 bucket and the other is ec2. So as soon as you do terraform apply,this terraform.tfstate file gets updated and this terraform.tfstate file is managing your resources.
--- If you see in the terraform.tfstate file you can see all the detailed and state of the resources you have created and running. You can see every detail of the resources.
--- So this is how your terrafrom knows that wether it has to create or delete or update something. 

--- Now lets create a new bucket add this in the main.tf code

resource "aws_s3_bucket" "mynews3" {
    bucket = "mynewbucket26856"
    tags = {
        Name = "demoec2instance"
        Environment = "Dev"
        Owner = "devopsuser"
    }
}

--- Now if you do terraform plan and terraform apply.
--- Now as soon as you did terraform plan it says that a the new s3 bucket will be created. So what did terraform do?
--- It checked the code, it compared it with the tfstate file and it found that in tfstate there are only 2 resources myfirstbucket and myec2. So it compared and there is one extra resource, so it requested aws and from aws it brough the details about what is the actual situation on aws.
--- On aws we do not have this new bucket so it decided that this new bucket as to be created.
--- So, whenever you do terraform apply, aws create a resource on cloud and then it comes and updates all about it in tfstate file. So, everytime your tfstate file going to match with the actaul state of resources on AWS.
--- Even when we did modification of instance type it did the 3 way comparision of code, tfstate and aws. Then it updated accordingly.
--- Now tfstate file is very important, if is deleted terraform does not know which resource is running, which is needs to be modifed as it lost all the detailed.
--- If the tfstate is delete if you run the code it will again create all the resources since it doesnot have the infromation that what you have on aws already. SO it wil try to create all the resources again.
--- Now if you wanna remove a resource, just remove the resource from the code and do terraform apply.
--- If you want to delete all the resources you can just do terrafrom destroy.
-----------------------

resource "aws_s3_bucket" "mys3" {
    bucket = "myfirstbucket26856"
    tags = {
        Name = "demoec2instance"
        Environment = "Dev"
        Owner = "devopsuser"
    }
}


resource "aws_instance" "myec2" {
    ami = "ami-0861f4e788f5069dd"
    instance_type = "t2.mirco"
    tags = {
        Name = "demoec2instance"
        Environment = "Dev"
        Owner = "devopsuser"
    }
}

--- Now we are writing the code but let us not talk about good practices and how to enchace the terraform code.

--- Now if you see the code we have hardcoded some stuff in the code. Like instance type, AMI id and etc.
--- But we do not want to hard code things. 
--- So we will create a block called 'variables'. 

--- variables "name of the varible" {}. So we can do it:

variables "ami_id" {
   type = string  ### type is data type - like string, boolean and etc.
}

variables "instance_type" {
   type = string  ### type is data type - like string, boolean and etc.
}

variables "bucket_name" {
   type = string  ### type is data type - like string, boolean and etc.
}

--- So we have created two variables for ami_id and instance_type.
--- So basically we are declaring the variable that the variable name is ami_id and type is string.
--- Now we can give this variables default values. If you do not give the default value, then you have to pass the value while doing terrafrom apply.
--- Now lets remove the hardcoding. Before we remove the value save the values somehere, so that you can use them to pass during terrafrom apply..
--- So the final code is : 

variables "ami_id" {
   type = string
}

variables "instance_type" {
   type = string  
}

variables "bucket_name" {
   type = string
}

resource "aws_s3_bucket" "mys3" {
    bucket = var.bucket_name
    tags = {
        Name = "demoec2instance"
        Environment = "Dev"
        Owner = "devopsuser"
    }
}


resource "aws_instance" "myec2" {
    ami = var.ami_id
    instance_type = var.instance_type
    tags = {
        Name = "demoec2instance"
        Environment = "Dev"
        Owner = "devopsuser"
    }
}


--- Now do terraform apply.
--- You will be asked to pass the values enter the values. ami_id, instance_type and bucket_name.
--- This is a way of doing it.
--- If you do not want to give values in prompt you can do it while running terraform apply command.
--- terraform apply -var="bucket_name=name of bucket" -var="ami_id= ami id" -var"instance_type=t2.micro"
--- Now you are asked for values in prompt. 

--- Now in variables you can give default type also. 

variables "ami_id" {
   type = string
   defaul = "ami-0861f4e788f5069dd"
}

variables "instance_type" {
   type = string  
   default = "t2.micro"
}

variables "bucket_name" {
   type = string
}

resource "aws_s3_bucket" "mys3" {
    bucket = var.bucket_name
    tags = {
        Name = "demoec2instance"
        Environment = "Dev"
        Owner = "devopsuser"
    }
}


resource "aws_instance" "myec2" {
    ami = var.ami_id
    instance_type = var.instance_type
    tags = {
        Name = "demoec2instance"
        Environment = "Dev"
        Owner = "devopsuser"
    }
}

--- Now if you do terraform apply it will not ask to pass the value of ami_id and instance_type. 

--- Now you have a command 'terraform fmt', this will format the code. So, if your code is not formated maybe extra spaces and etc it will format it.
--- Now you have a command 'Terraform validate', this will check your syntax. Maybe youcan remove a '{' from your code and do terraform validate. It gives you error.
----------------------------

--- Now similar to variable block we also have output block as well.
--- If you want some values as output.
--- Suppose we have created the ec2 instance and we want the private IP of the instance. We want see that when run terrform apply. For that we have output.
--- Add below to the code.

output "ec2privateIP"{
   value = aws_instance.myec2.private_ip
}

output "ec2arn"{
   value = aws_instance.myec2.arn
}

--- Here is the full code.
--- also let us add default value in variables for bucket name.

variables "ami_id" {
   type = string
   default = "ami-0861f4e788f5069dd"
}

variables "instance_type" {
   type = string  
   default = "t2.micro"
}

variables "bucket_name" {
   type = string
   default = "myfirstbucket26856"
}

resource "aws_s3_bucket" "mys3" {
    bucket = var.bucket_name
    tags = {
        Name = "demoec2instance"
        Environment = "Dev"
        Owner = "devopsuser"
    }
}


resource "aws_instance" "myec2" {
    ami = var.ami_id
    instance_type = var.instance_type
    tags = {
        Name = "demoec2instance"
        Environment = "Dev"
        Owner = "devopsuser"
    }
}

output "ec2privateIP"{
   value = aws_instance.myec2.private_ip
}

output "ec2arn"{
   value = aws_instance.myec2.arn
}



--- Now do terraform apply.
--- You can see the output.
--------------------

--- We have everything in one file which is main.tf. You can also put even provider into this one file.
--- But what if my code is very huge it would ve very complex.So, putting all in same file cannot be a good practice.
--- So, lets keep them in different files.

--- First create 'variables.tf' and we will move all the variables to this file. So, copy and paste it in this file and save it.
--- Now create 'outputs.tf' and move all the ouputs to this file.
--- Now main.tf has only resource code. Also it would be easy to understand things.
--- This would not changes anything. Since when you do terraform apply, terrform will read all the .tf files and executes.
---------------------

--- Now what if someone do not want to give default values in variables? He would do it in the terminal as we seen before by passing the values. 
--- But right now we have only 3 variables and what if there are 50 variables? It would be very complex to pass the values in the terminal.
--- So in terraform we can create a file called 'terraform.tfvars', in this terraform.tfvars we can put our key values.

--- create a file 'terraform.tfvars' ---> it is standard naming, so it has to be 'Terraform.tfvars' only
--- Now lets put all the values into the folder.

ami_id = "ami-0861f4e788f5069dd"
instance_type = "t2.micro"
bucket_name = "myfirstbucket26856"

--- Now do terraform apply.

--- If you do not use the standard naming as 'Terraform.tfvars' but different name. 
--- Maybe we have created file with name 'myvalues.tfvars'. --->name.tfvars ---> .tfvars is must you cannot change it.
--- then you can do terraform apply with the following command
--- terrafrom apply -var-file="myvalues.tfvars"
-------------------------------------

--- Till now we have seen resource block, variables block, output and now lets see data block.
--- Lets say there is a resource which is already existing in aws account, which we have not created using terraform or maybe using terrform it doesn't matter. But there is a resource that is existing in your aws account.
--- And I want to get the value of it.
--- Example : We have VPC, there is a VPC which is already there and I want to get the value of that VPC. Myabe we want to get the VPC ID of a VPC which is on the AWS accont.
--- For that we can use the data source, to get the value of something which is already existing.
--- Now lets say here is Secrets Manager, on aws in secret manager we can store secrets. Where we store some key and values.
--- First lets create a secret in in secret manager.
--- Search for secret manager on aws console and then click on it.
--- Cick on 'Store a new secret' ---> Select 'Other type of secret from the options' ---> In Key/value pair enter "dbpass & gdyefwefbf" ---> Next 
--- Secret name "mydbpass" ---> Next ---> Next ---> Store.
--- So, now we have created a secret and now i want to get the value of that secrets in my code.
--- Maybe I want to create a resource which needs the value of that resource. Maybe I am creating a database and the value of the secret I have to refer from secret manager.
--- Now, we have not created this secret using terrraform but we have created it manually from console. But we want to extarct some details from it.
--- So, I will use 'data source'.

---- You can check hwo to write data source from terraform documentation. Search vpc data source terraform.

data "aws_vpc" "vpcdatasource" {
     id = "give your vpc id" 
} 

--- So we have provided the value to the data source that I want to extract the value of the VPC which is having certain ID.
--- If you want to create output vairiable you can create that.

--- Add this to output.tf file 

output "vpc_cidr {
     value = data.aws_vpc.vpcdatasource.cidr_block"
}

--- now run terraform apply

--- Now this to your code:

data "aws_secretsmanager_secret" "mysecretname" {
      name = "mydbpass"
}

data "aws_secretsmanager_secret_version" "secret-version" {
      secret_id = data.aws_secretmanager_secret.mysecretname.id
}

--- Now if we want to get the value of it we can go and create it in the output section.

output "mysecretvalue" {
    value = data.aws_secretsmanager_secret_version.secret-version.secret_string
    sensitive = true
}

--- Since we are trying to extarct sensitive information, we are using sensitive = true.

--- Do terraform plan and then terraform apply.

--- So, data source is block which we can use to retrieve the value of something which is already created in aws.

---- DO terraform destroy, this will destory all that we have created so that you won't be charged by aws. 

--------------- End of class 2 of terraform.
